#! /bin/sh

if [ $# -lt 2 ]; then
    cat <<USAGE
Usage: $0 dir [ path ] ... output_directory
Example: $0 notes/chinese/20171006 notes/english ~/Downloads/
USAGE
    exit 1;
fi
src=${@:1:$# - 1}
dst=${@:$#:1}

F_BASIC="${dst}/anki_basic.txt"
F_CLOZE="${dst}/anki_cloze.txt"
if [ -e "${F_BASIC}" ]; then
    rm "${F_BASIC}"
fi
if [ -e "${F_CLOZE}" ]; then
    rm "${F_CLOZE}"
fi

IFS="
"
chunk=""
for line in $(find "${src}" -type f -exec sh -c 'cat {} && echo "___"' \;)
do if [ -n "${line}" ]; then
    if [ "${line}" == "___" ]; then
        case "${chunk}" in
            *\<c1\>*)
                fname="${F_CLOZE}";;
            *)
                fname="${F_BASIC}";;
        esac
        echo "\"${chunk}${IFS}\"" | sed 's,!\[[^]]*\](\([^)]*\)),<img src='"'"'\1'"'"' />,g' >> "${fname}"
        chunk=""
    else
        chunk="${chunk}${IFS}${line}"
    fi
fi
done
if [ -e "${F_CLOZE}" ]; then
    sed -i '' 's/<c\([0-9]\)>/{{c\1::/g;s/<\/c[0-9]>/}}/g' "${F_CLOZE}"
fi
